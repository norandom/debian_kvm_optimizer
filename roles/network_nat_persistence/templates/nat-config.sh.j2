#!/bin/bash
# NAT Configuration Script
# Auto-generated by Ansible - do not edit manually

LOG_FILE="/var/log/nat-config.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Applying NAT configuration" >> $LOG_FILE

# Enable IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# Clear existing NAT rules (except libvirt)
iptables -t nat -F PREROUTING || true
iptables -t nat -F POSTROUTING || true

# Add MASQUERADE rule for outbound traffic
iptables -t nat -A POSTROUTING -o {{ network_interfaces.primary }} -j MASQUERADE

# Configure port forwarding rules
{% for forward in port_forwards %}
{% if forward.host_port_range is defined %}
# Port range forwarding: {{ forward.name }}
for PORT in {{ forward.host_port_range.split(':')[0] }}..{{ forward.host_port_range.split(':')[1] }}; do
    iptables -I FORWARD -o {{ network_interfaces.bridge }} -p {{ forward.protocol }} -d {{ forward.guest_ip }} --dport {{ forward.guest_port }} -j ACCEPT
    iptables -t nat -I PREROUTING -p {{ forward.protocol }} --dport $PORT -j DNAT --to {{ forward.guest_ip }}:{{ forward.guest_port }}
done
{% else %}
# Single port forwarding: {{ forward.name }}
{% if forward.interface != "*" %}
iptables -t nat -I PREROUTING -i {{ forward.interface }} -p {{ forward.protocol }} --dport {{ forward.host_port }} -j DNAT --to {{ forward.guest_ip }}:{{ forward.guest_port }}
{% else %}
iptables -t nat -I PREROUTING -p {{ forward.protocol }} --dport {{ forward.host_port }} -j DNAT --to {{ forward.guest_ip }}:{{ forward.guest_port }}
{% endif %}
iptables -I FORWARD -o {{ network_interfaces.bridge }} -p {{ forward.protocol }} -d {{ forward.guest_ip }} --dport {{ forward.guest_port }} -j ACCEPT
{% endif %}
{% endfor %}

# Allow general traffic to the guest IP (for existing connections)
iptables -I FORWARD -d {{ port_forwards[0].guest_ip }} -j ACCEPT

# Log applied configuration
echo "[$TIMESTAMP] NAT configuration applied successfully" >> $LOG_FILE
echo "[$TIMESTAMP] Active port forwards:" >> $LOG_FILE
{% for forward in port_forwards %}
echo "  - {{ forward.name }}: {{ forward.host_port | default(forward.host_port_range) }} -> {{ forward.guest_ip }}:{{ forward.guest_port }}" >> $LOG_FILE
{% endfor %}