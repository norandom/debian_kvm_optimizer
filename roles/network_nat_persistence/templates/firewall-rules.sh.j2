#!/bin/bash
# Consolidated Firewall Rules Script
# Auto-generated by Ansible - do not edit manually

LOG_FILE="/var/log/firewall-rules.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Applying firewall rules" >> $LOG_FILE

# Block DNS requests on external interface to prevent DNS leaks
{% for rule in firewall_rules.block_dns %}
iptables -A INPUT -i {{ rule.interface }} -p {{ rule.protocol }} --dport {{ rule.port }} -j DROP
ip6tables -A INPUT -i {{ rule.interface }} -p {{ rule.protocol }} --dport {{ rule.port }} -j DROP
{% endfor %}

# Block DHCP requests on external interface
{% for rule in firewall_rules.block_dhcp %}
iptables -A INPUT -i {{ rule.interface }} -p {{ rule.protocol }} --dport {{ rule.port }} -j DROP
ip6tables -A INPUT -i {{ rule.interface }} -p {{ rule.protocol }} --dport {{ rule.port }} -j DROP
{% endfor %}

# Allow SSH access to host
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Allow established connections
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow loopback traffic
iptables -A INPUT -i lo -j ACCEPT

# Log applied rules
echo "[$TIMESTAMP] Firewall rules applied successfully" >> $LOG_FILE