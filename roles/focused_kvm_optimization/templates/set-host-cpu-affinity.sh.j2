#!/bin/bash
# Set CPU affinity for host processes - bind to core 0 only
# Auto-generated by Ansible - do not edit manually

LOG_FILE="/var/log/host-cpu-affinity.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Setting CPU affinity for host processes" >> $LOG_FILE

# Set affinity for key system processes to core 0
for process in systemd kthreadd ksoftirqd migration rcu_gp rcu_par_gp; do
    pids=$(pgrep -f "^$process" 2>/dev/null)
    if [[ -n "$pids" ]]; then
        for pid in $pids; do
            if [[ -d "/proc/$pid" ]]; then
                taskset -cp 0 $pid 2>/dev/null
                echo "[$TIMESTAMP] Set CPU affinity for $process (PID: $pid) to core 0" >> $LOG_FILE
            fi
        done
    fi
done

# Set affinity for IRQ handling
for irq in /proc/irq/*/smp_affinity; do
    if [[ -w "$irq" ]]; then
        echo "1" > "$irq" 2>/dev/null  # Core 0 only
    fi
done

# Set affinity for network interfaces
for iface in /sys/class/net/*/queues/rx-*/rps_cpus; do
    if [[ -w "$iface" ]]; then
        echo "1" > "$iface" 2>/dev/null  # Core 0 only
    fi
done

echo "[$TIMESTAMP] Host CPU affinity configuration completed" >> $LOG_FILE